angular.module("fluro.access",["fluro.content"]),angular.module("fluro.access").service("FluroAccess",["$rootScope","$q","FluroContent",function(a,b,c){var d={};return d.isFluroAdmin=function(){return!!a.user&&"administrator"==a.user.accountType},d.getPermissionSets=function(){return a.user?a.user.permissionSets:[]},d.has=function(b){if(!a.user)return!1;var c=a.user.permissionSets,d=_.chain(c).map(function(a){return a.permissions}).flatten().uniq().value();return _.includes(d,b)},d.canAccess=function(b,c){if(!a.user)return!1;if(d.isFluroAdmin())return!0;var e=(d.retrieveActionableRealms("create "+b),d.retrieveActionableRealms("view own "+b)),f=d.retrieveActionableRealms("view any "+b),g=d.retrieveActionableRealms("edit own "+b),h=d.retrieveActionableRealms("edit any "+b),i=[];if(i=i.concat(e),i=i.concat(f),i=i.concat(g),i=i.concat(h),i.length)return!0;if(c&&c.length){var j=d.retrieveActionableRealms("include defined "+c);if(!j.length)return!1;var k=(d.retrieveActionableRealms("create "+c),d.retrieveActionableRealms("view own "+c)),l=d.retrieveActionableRealms("view any "+c),m=d.retrieveActionableRealms("edit own "+c),n=d.retrieveActionableRealms("edit any "+c),i=[];if(i=i.concat(k),i=i.concat(l),i=i.concat(m),i=i.concat(n),i.length)return!0}return!1},d.retrieveActionableRealms=function(b){if(!a.user)return[];var c=a.user.permissionSets;return _.chain(c).map(function(a,c){var d=b;if(_.includes(a.permissions,d))return c.toString()}).compact().value()},d.retrieveSelectableRealms=function(b,e,f,g){if(!a.user)return[];var h;if(d.isFluroAdmin())h=c.resource("realm",!1,g).query({list:!0,sort:"title"});else{var i=a.user.permissionSets,j=b+" "+e,k=_.chain(i).filter(function(a,c){var d,e=_.includes(a.permissions,j);if(f&&f.length){var g=_.includes(a.permissions,b+" "+f),h=_.includes(a.permissions,"include defined "+f);d=g&&h}return e||d}).compact().sortBy("title").value();h=k}return h},d.can=function(b,c,e){if(!a.user)return!1;if(d.isFluroAdmin())return!0;var f=b+" "+c,g=[];switch(b){case"view any":var h=d.retrieveActionableRealms("view any "+c),i=d.retrieveActionableRealms("edit any "+c);g=g.concat(h),g=g.concat(i);break;case"view own":var j=d.retrieveActionableRealms("view own "+c),k=d.retrieveActionableRealms("edit own "+c);g=g.concat(j),g=g.concat(k);break;default:g=d.retrieveActionableRealms(f)}if(g.length)return!0;if(e&&e.length){var l=d.retrieveActionableRealms("include defined "+e);if(!l.length)return!1;switch(b){case"view any":d.retrieveActionableRealms("view any "+e),d.retrieveActionableRealms("edit any "+e);g=g.concat(h),g=g.concat(i);break;case"view own":var m=d.retrieveActionableRealms("view own "+e),n=d.retrieveActionableRealms("edit own "+e);g=g.concat(m),g=g.concat(n);break;default:g=d.retrieveActionableRealms(b+" "+e)}if(g.length)return!0}return!1},d.isAuthor=function(b){if(!a.user)return!1;var c=!1;return c=_.isObject(b.author)?b.author._id==a.user._id:b.author==a.user._id,!c&&b.owners&&b.owners.length&&(c=_.some(b.owners,function(b){var c=b;return c&&c._id&&(c=c._id),c==a.user._id})),a.user._id==b._id&&(c=!0),c},d.canEditItem=function(b,c){if(!b)return!1;if(!a.user)return!1;var e=a.user.account;e&&(e=e._id);var f=b.account;if(f&&f._id&&(f=f._id),f&&f!=e)return!1;if(d.isFluroAdmin())return!0;var g,h=b._type;b.definition&&(h=b.definition,g=b._type);var i=d.isAuthor(b);if(c&&(h="user",i))return!0;switch(h){case"realm":return i?d.has("edit own realm"):d.has("edit any realm")}var j=d.retrieveActionableRealms("edit any "+h),k=d.retrieveActionableRealms("edit own "+h),l=_.map(b.realms,function(a){return a._id?a._id:a});if(g&&g.length){var m=d.retrieveActionableRealms("include defined "+g);if(m.length){var n=d.retrieveActionableRealms("edit any "+g);j=j.concat(n);var o=d.retrieveActionableRealms("edit own "+g);k=k.concat(o)}}var p=_.intersection(j,l);if(p.length)return!0;if(i){var q=_.intersection(k,l);if(q.length)return!0}},d.canViewItem=function(b,c){if(!a.user)return!1;if(d.isFluroAdmin())return!0;var e,f=b._type;b.definition&&(f=b.definition,e=b._type);var g=d.isAuthor(b);if(c&&(f="user",g))return!0;var h=d.retrieveActionableRealms("view any "+f),i=d.retrieveActionableRealms("view own "+f),j=d.retrieveActionableRealms("edit any "+f),k=d.retrieveActionableRealms("edit own "+f),l=[];l=l.concat(h),l=l.concat(j);var m=[];m=m.concat(i),m=m.concat(k);var n=_.map(b.realms,function(a){return a._id?a._id:a});if(e&&e.length){var o=d.retrieveActionableRealms("include defined "+e);if(o.length){var p=d.retrieveActionableRealms("edit any "+e),q=d.retrieveActionableRealms("view any "+e);l=l.concat(p,q);var r=d.retrieveActionableRealms("edit own "+e),s=d.retrieveActionableRealms("view own "+e);m=m.concat(r,s)}}var t=_.intersection(l,n);if(t.length)return!0;if(g){var u=_.intersection(m,n);if(u.length)return!0}},d.canDeleteItem=function(b,c){if(!a.user)return!1;var e=a.user.account;e&&(e=e._id);var f=b.account;if(f&&f._id&&(f=f._id),f&&f!=e)return!1;if(d.isFluroAdmin())return!0;var g,h=b._type;b.definition&&(h=b.definition,g=b._type);var i=d.isAuthor(b);if(c&&(h="user",i))return!0;switch(h){case"realm":return i?d.has("delete own realm"):d.has("delete any realm")}var j=d.retrieveActionableRealms("delete any "+h),k=d.retrieveActionableRealms("delete own "+h),l=_.map(b.realms,function(a){return a&&a._id?a._id:a});if(g&&g.length){var m=d.retrieveActionableRealms("include defined "+g);if(m.length){var n=d.retrieveActionableRealms("delete any "+g);j=j.concat(n);var o=d.retrieveActionableRealms("delete own "+g);k=k.concat(o)}}var p=_.intersection(j,l);if(p.length)return!0;if(i){var q=_.intersection(k,l);if(q.length)return!0}},d.resolveIf=function(a){var c=b.defer();return a?c.resolve():c.reject(),c.promise},d}]);