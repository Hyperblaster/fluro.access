angular.module("fluro.access",["fluro.content"]),angular.module("fluro.access").service("FluroAccess",["$rootScope","$q","FluroContent",function(a,b,c){function d(a,b){a.children&&a.children.length&&_.each(a.children,function(a){d(a,b)}),b.push(String(a._id))}function e(a){var b=[a];return a.children&&a.children.length&&_.each(a.children,function(a){var c=e(a);b=b.concat(c)}),b}var f={};return f.isFluroAdmin=function(){return!!a.user&&("administrator"==a.user.accountType&&!a.user.pretender)},f.getPermissionSets=function(){return a.user?a.user.permissionSets:[]},f.has=function(b){if(!a.user)return!1;if(f.isFluroAdmin())return!0;var c=a.user.permissionSets,d=_.chain(c).reduce(function(a,b,c){return a.push(b.permissions),a},[]).flattenDeep().compact().uniq().value();return _.includes(d,b)},f.canAccess=function(b,c){if(!a.user)return!1;if(f.isFluroAdmin())return!0;var d=f.retrieveActionableRealms("create "+b),e=f.retrieveActionableRealms("view own "+b),g=f.retrieveActionableRealms("view any "+b),h=f.retrieveActionableRealms("edit own "+b),i=f.retrieveActionableRealms("edit any "+b),j=[];if(j=j.concat(d),j=j.concat(e),j=j.concat(g),j=j.concat(h),j=j.concat(i),j.length)return!0;if(c&&c.length){var k=f.retrieveActionableRealms("include defined "+c);if(!k.length)return!1;var l=(f.retrieveActionableRealms("create "+c),f.retrieveActionableRealms("view own "+c)),m=f.retrieveActionableRealms("view any "+c),n=f.retrieveActionableRealms("edit own "+c),o=f.retrieveActionableRealms("edit any "+c),j=[];if(j=j.concat(l),j=j.concat(m),j=j.concat(n),j=j.concat(o),j.length)return!0}return!1},f.retrieveActionableRealms=function(b){if(!a.user)return[];var c=a.user.permissionSets;return _.chain(c).map(function(a,c){var e=b,f=_.includes(a.permissions,e);if(f){var g=[];return d(a,g),g}}).flatten().compact().value()},f.retrieveSelectableRealms=function(d,g,h,i){var j=b.defer();if(!a.user)return j.resolve([]),j.promise;if(f.isFluroAdmin())c.endpoint("realm/tree",!1,i).query({}).$promise.then(j.resolve,j.reject);else{var k=a.user.permissionSets,l=d+" "+g,m=_.chain(k).filter(function(a,b){var c,e=_.includes(a.permissions,l);if(h&&h.length){var f=_.includes(a.permissions,d+" "+h),g=_.includes(a.permissions,"include defined "+h);c=f&&g}var i=e||c;return i}).map(e).flattenDeep().map(function(a){return _.pick(a,["title","definition","_discriminator","_discriminatorType","trail","color","bgColor","_id"])}).uniq(function(a){return a._id}).sortBy(function(a){return a.trail?a.trail.length:0}).reduce(function(a,b){var c=_.last(b.trail);return a[c]&&(a[c].children||(a[c].children=[]),a[c].children.push(b),b.nested=!0),a[b._id]=b,a},{}).values().filter(function(a){return!a.nested}).sortBy(function(a){return a.title}).value(),n=angular.copy(m);j.resolve(n)}return j.promise},f.can=function(b,c,d){if(!a.user)return!1;if(f.isFluroAdmin())return!0;var e=b+" "+c,g=[];switch(b){case"view any":var h=f.retrieveActionableRealms("view any "+c),i=f.retrieveActionableRealms("edit any "+c);g=g.concat(h),g=g.concat(i);break;case"view own":var j=f.retrieveActionableRealms("view own "+c),k=f.retrieveActionableRealms("edit own "+c);g=g.concat(j),g=g.concat(k);break;default:g=f.retrieveActionableRealms(e)}if(g.length)return!0;if(d&&d.length){var l=f.retrieveActionableRealms("include defined "+d);if(!l.length)return!1;switch(b){case"view any":f.retrieveActionableRealms("view any "+d),f.retrieveActionableRealms("edit any "+d);g=g.concat(h),g=g.concat(i);break;case"view own":var m=f.retrieveActionableRealms("view own "+d),n=f.retrieveActionableRealms("edit own "+d);g=g.concat(m),g=g.concat(n);break;default:g=f.retrieveActionableRealms(b+" "+d)}if(g.length)return!0}return!1},f.isAuthor=function(b){if(!a.user)return!1;var c=!1;return c=_.isObject(b.author)?b.author._id==a.user._id:b.author==a.user._id,c=_.isObject(b.managedAuthor)?b.managedAuthor._id==a.user.persona:b.managedAuthor==a.user.persona,!c&&b.owners&&b.owners.length&&(c=_.some(b.owners,function(b){var c=b;return c&&c._id&&(c=c._id),c==a.user._id})),!c&&b.managedOwners&&b.managedOwners.length&&(c=_.some(b.managedOwners,function(b){var c=b;return c&&c._id&&(c=c._id),c==a.user.persona})),a.user._id==b._id&&(c=!0),c},f.canAccessChat=function(a,b,c){b&&b.length||(b=a._type),c&&c.length||(c=a.definition&&a.definition.length?a.definition:b);var d=f.retrieveSelectableRealms("chat",c,b),e=f.retrieveSelectableRealms("view chat",c,b),g=_.map(a.realms,function(a){return a._id&&(a=a._id),a}),h=f.canEditItem(a);if(h)return!0;var i=_.intersection(d,g).length;if(i)return!0;var j=_.intersection(e,g).length;return!!j||void 0},f.canEditItem=function(b,c){if(!b)return!1;if(!a.user)return!1;var d=a.user.account;d&&(d=d._id);var e=b.account;if(e&&e._id&&(e=e._id),e&&e!=d)return!1;if(f.isFluroAdmin())return!0;if(b._type&&"realm"!=b._type&&b.realms&&!b.realms.length)return!0;if(b.assignedTo&&b.assignedTo.length){var g=_.intersection(_.chain(b.assignedTo).map(function(a){return a&&a._id?a._id:a}).compact().value(),a.user.contacts);return g&&g.length}b.assignedToTeam&&b.assignedToTeam.length;var h,i=b._type;b.definition&&(i=b.definition,h=b._type);var j=f.isAuthor(b);if(c&&(i="user",j))return!0;var k,l=f.retrieveActionableRealms("edit any "+i),m=f.retrieveActionableRealms("edit own "+i);if("realm"==i||"realm"==h?(k=_.map(b.trail,function(a){return a._id?a._id:a}),k.push(b._id)):k=_.map(b.realms,function(a){return a._id?a._id:a}),h&&h.length){var n=f.retrieveActionableRealms("include defined "+h);if(n.length){var o=f.retrieveActionableRealms("edit any "+h);l=l.concat(o);var p=f.retrieveActionableRealms("edit own "+h);m=m.concat(p)}}var q=_.intersection(l,k);if(q.length)return!0;if(j){var r=_.intersection(m,k);if(r.length)return!0}},f.canViewItem=function(b,c){if(!a.user)return!1;if(f.isFluroAdmin())return!0;if(b._type&&"realm"!=b._type&&b.realms&&!b.realms.length)return!0;var d,e=b._type;b.definition&&(e=b.definition,d=b._type);var g=f.isAuthor(b);if(c&&(e="user",g))return!0;var h=f.retrieveActionableRealms("view any "+e),i=f.retrieveActionableRealms("view own "+e),j=f.retrieveActionableRealms("edit any "+e),k=f.retrieveActionableRealms("edit own "+e),l=[];l=l.concat(h),l=l.concat(j);var m=[];m=m.concat(i),m=m.concat(k);var n;if("realm"==e||"realm"==d?(n=_.map(b.trail,function(a){return a._id?a._id:a}),n.push(b._id)):n=_.map(b.realms,function(a){return a._id?a._id:a}),d&&d.length){var o=f.retrieveActionableRealms("include defined "+d);if(o.length){var p=f.retrieveActionableRealms("edit any "+d),q=f.retrieveActionableRealms("view any "+d);l=l.concat(p,q);var r=f.retrieveActionableRealms("edit own "+d),s=f.retrieveActionableRealms("view own "+d);m=m.concat(r,s)}}var t=_.intersection(l,n);if(t.length)return!0;if(g){var u=_.intersection(m,n);if(u.length)return!0}},f.canDeleteItem=function(b,c){if(!a.user)return!1;var d=a.user.account;d&&(d=d._id);var e=b.account;if(e&&e._id&&(e=e._id),e&&e!=d)return!1;if(f.isFluroAdmin())return!0;if(b._type&&"realm"!=b._type&&b.realms&&!b.realms.length)return!0;var g,h=b._type;b.definition&&(h=b.definition,g=b._type);var i=f.isAuthor(b);if(c&&(h="user",i))return!0;var j,k=f.retrieveActionableRealms("delete any "+h),l=f.retrieveActionableRealms("delete own "+h);if("realm"==h||"realm"==g?(j=_.map(b.trail,function(a){return a._id?a._id:a}),j.push(b._id)):j=_.map(b.realms,function(a){return a._id?a._id:a}),g&&g.length){var m=f.retrieveActionableRealms("include defined "+g);if(m.length){var n=f.retrieveActionableRealms("delete any "+g);k=k.concat(n);var o=f.retrieveActionableRealms("delete own "+g);l=l.concat(o)}}var p=_.intersection(k,j);if(p.length)return!0;if(i){var q=_.intersection(l,j);if(q.length)return!0}},f.resolveIf=function(a){var c=b.defer();return a?c.resolve():c.reject(),c.promise},f}]);