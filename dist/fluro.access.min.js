angular.module("fluro.access",["fluro.content"]),angular.module("fluro.access").service("FluroAccess",["$rootScope","$q","FluroContent",function(a,b,c){function d(a,b){a.children&&a.children.length&&_.each(a.children,function(a){d(a,b)}),b.push(String(a._id))}function e(a){var b=[a];return a.children&&a.children.length&&_.each(a.children,function(a){var c=e(a);b=b.concat(c)}),b}var f={};return f.isFluroAdmin=function(){return!!a.user&&"administrator"==a.user.accountType},f.getPermissionSets=function(){return a.user?a.user.permissionSets:[]},f.has=function(b){if(!a.user)return!1;var c=a.user.permissionSets,d=_.chain(c).map(e).flattenDeep().uniq().value();return _.includes(d,b)},f.canAccess=function(b,c){if(!a.user)return!1;if(f.isFluroAdmin())return!0;var d=f.retrieveActionableRealms("create "+b),e=f.retrieveActionableRealms("view own "+b),g=f.retrieveActionableRealms("view any "+b),h=f.retrieveActionableRealms("edit own "+b),i=f.retrieveActionableRealms("edit any "+b),j=[];if(j=j.concat(d),j=j.concat(e),j=j.concat(g),j=j.concat(h),j=j.concat(i),j.length)return!0;if(c&&c.length){var k=f.retrieveActionableRealms("include defined "+c);if(!k.length)return!1;var l=(f.retrieveActionableRealms("create "+c),f.retrieveActionableRealms("view own "+c)),m=f.retrieveActionableRealms("view any "+c),n=f.retrieveActionableRealms("edit own "+c),o=f.retrieveActionableRealms("edit any "+c),j=[];if(j=j.concat(l),j=j.concat(m),j=j.concat(n),j=j.concat(o),j.length)return!0}return!1},f.retrieveActionableRealms=function(b){if(!a.user)return[];var c=a.user.permissionSets;return _.chain(c).map(function(a,c){var e=b,f=_.includes(a.permissions,e);if(f){var g=[];return d(a,g),g}}).flatten().compact().value()},f.retrieveSelectableRealms=function(b,d,g,h){if(!a.user)return[];var i;if(f.isFluroAdmin())i=c.resource("realm",!1,h).query({list:!0,sort:"title"});else{var j=a.user.permissionSets,k=b+" "+d,l=_.chain(j).filter(function(a,c){var d,e=_.includes(a.permissions,k);if(g&&g.length){var f=_.includes(a.permissions,b+" "+g),h=_.includes(a.permissions,"include defined "+g);d=f&&h}var i=e||d;return i}).map(e).flattenDeep().compact().sortBy("title").value();i=l}return i},f.can=function(b,c,d){if(!a.user)return!1;if(f.isFluroAdmin())return!0;var e=b+" "+c,g=[];switch(b){case"view any":var h=f.retrieveActionableRealms("view any "+c),i=f.retrieveActionableRealms("edit any "+c);g=g.concat(h),g=g.concat(i);break;case"view own":var j=f.retrieveActionableRealms("view own "+c),k=f.retrieveActionableRealms("edit own "+c);g=g.concat(j),g=g.concat(k);break;default:g=f.retrieveActionableRealms(e)}if(g.length)return!0;if(d&&d.length){var l=f.retrieveActionableRealms("include defined "+d);if(!l.length)return!1;switch(b){case"view any":f.retrieveActionableRealms("view any "+d),f.retrieveActionableRealms("edit any "+d);g=g.concat(h),g=g.concat(i);break;case"view own":var m=f.retrieveActionableRealms("view own "+d),n=f.retrieveActionableRealms("edit own "+d);g=g.concat(m),g=g.concat(n);break;default:g=f.retrieveActionableRealms(b+" "+d)}if(g.length)return!0}return!1},f.isAuthor=function(b){if(!a.user)return!1;var c=!1;return c=_.isObject(b.author)?b.author._id==a.user._id:b.author==a.user._id,!c&&b.owners&&b.owners.length&&(c=_.some(b.owners,function(b){var c=b;return c&&c._id&&(c=c._id),c==a.user._id})),a.user._id==b._id&&(c=!0),c},f.canEditItem=function(b,c){if(!b)return!1;if(!a.user)return!1;var d=a.user.account;d&&(d=d._id);var e=b.account;if(e&&e._id&&(e=e._id),e&&e!=d)return!1;if(f.isFluroAdmin())return!0;var g,h=b._type;b.definition&&(h=b.definition,g=b._type);var i=f.isAuthor(b);if(c&&(h="user",i))return!0;switch(h){case"realm":return i?f.has("edit own realm"):f.has("edit any realm")}var j=f.retrieveActionableRealms("edit any "+h),k=f.retrieveActionableRealms("edit own "+h),l=_.map(b.realms,function(a){return a._id?a._id:a});if(g&&g.length){var m=f.retrieveActionableRealms("include defined "+g);if(m.length){var n=f.retrieveActionableRealms("edit any "+g);j=j.concat(n);var o=f.retrieveActionableRealms("edit own "+g);k=k.concat(o)}}var p=_.intersection(j,l);if(p.length)return!0;if(i){var q=_.intersection(k,l);if(q.length)return!0}},f.canViewItem=function(b,c){if(!a.user)return!1;if(f.isFluroAdmin())return!0;var d,e=b._type;b.definition&&(e=b.definition,d=b._type);var g=f.isAuthor(b);if(c&&(e="user",g))return!0;var h=f.retrieveActionableRealms("view any "+e),i=f.retrieveActionableRealms("view own "+e),j=f.retrieveActionableRealms("edit any "+e),k=f.retrieveActionableRealms("edit own "+e),l=[];l=l.concat(h),l=l.concat(j);var m=[];m=m.concat(i),m=m.concat(k);var n=_.map(b.realms,function(a){return a._id?a._id:a});if(d&&d.length){var o=f.retrieveActionableRealms("include defined "+d);if(o.length){var p=f.retrieveActionableRealms("edit any "+d),q=f.retrieveActionableRealms("view any "+d);l=l.concat(p,q);var r=f.retrieveActionableRealms("edit own "+d),s=f.retrieveActionableRealms("view own "+d);m=m.concat(r,s)}}var t=_.intersection(l,n);if(t.length)return!0;if(g){var u=_.intersection(m,n);if(u.length)return!0}},f.canDeleteItem=function(b,c){if(!a.user)return!1;var d=a.user.account;d&&(d=d._id);var e=b.account;if(e&&e._id&&(e=e._id),e&&e!=d)return!1;if(f.isFluroAdmin())return!0;var g,h=b._type;b.definition&&(h=b.definition,g=b._type);var i=f.isAuthor(b);if(c&&(h="user",i))return!0;switch(h){case"realm":return i?f.has("delete own realm"):f.has("delete any realm")}var j=f.retrieveActionableRealms("delete any "+h),k=f.retrieveActionableRealms("delete own "+h),l=_.map(b.realms,function(a){return a&&a._id?a._id:a});if(g&&g.length){var m=f.retrieveActionableRealms("include defined "+g);if(m.length){var n=f.retrieveActionableRealms("delete any "+g);j=j.concat(n);var o=f.retrieveActionableRealms("delete own "+g);k=k.concat(o)}}var p=_.intersection(j,l);if(p.length)return!0;if(i){var q=_.intersection(k,l);if(q.length)return!0}},f.resolveIf=function(a){var c=b.defer();return a?c.resolve():c.reject(),c.promise},f}]);