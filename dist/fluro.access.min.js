angular.module("fluro.access",["fluro.content"]),angular.module("fluro.access").service("FluroAccess",function($rootScope,$q,FluroContent){var controller={};return controller.isFluroAdmin=function(){return $rootScope.user?"administrator"==$rootScope.user.accountType:!1},controller.getPermissionSets=function(){return $rootScope.user?$rootScope.user.permissionSets:[]},controller.has=function(permission){if(!$rootScope.user)return!1;var permissionSets=$rootScope.user.permissionSets,permissions=_.chain(permissionSets).map(function(permissionSet){return permissionSet.permissions}).flatten().uniq().value();return _.includes(permissions,permission)},controller.canAccess=function(type,parentType){if(!$rootScope.user)return!1;if(controller.isFluroAdmin())return!0;var canViewOwnRealms=(controller.retrieveActionableRealms("create "+type),controller.retrieveActionableRealms("view own "+type)),canViewAnyRealms=controller.retrieveActionableRealms("view any "+type),canEditOwnRealms=controller.retrieveActionableRealms("edit own "+type),canEditAnyRealms=controller.retrieveActionableRealms("edit any "+type),totalRealms=[];if(totalRealms=totalRealms.concat(canViewOwnRealms),totalRealms=totalRealms.concat(canViewAnyRealms),totalRealms=totalRealms.concat(canEditOwnRealms),totalRealms=totalRealms.concat(canEditAnyRealms),totalRealms.length)return!0;if(parentType&&parentType.length){var includeDefined=controller.retrieveActionableRealms("include defined "+parentType);if(!includeDefined.length)return!1;var canViewOwnRealmsOnParentType=(controller.retrieveActionableRealms("create "+parentType),controller.retrieveActionableRealms("view own "+parentType)),canViewAnyRealmsOnParentType=controller.retrieveActionableRealms("view any "+parentType),canEditOwnRealmsOnParentType=controller.retrieveActionableRealms("edit own "+parentType),canEditAnyRealmsOnParentType=controller.retrieveActionableRealms("edit any "+parentType),totalRealms=[];if(totalRealms=totalRealms.concat(canViewOwnRealmsOnParentType),totalRealms=totalRealms.concat(canViewAnyRealmsOnParentType),totalRealms=totalRealms.concat(canEditOwnRealmsOnParentType),totalRealms=totalRealms.concat(canEditAnyRealmsOnParentType),totalRealms.length)return!0}return!1},controller.retrieveActionableRealms=function(action){if(!$rootScope.user)return[];var permissionSets=$rootScope.user.permissionSets;return _.chain(permissionSets).map(function(realmSet,key){var searchString=action;return _.includes(realmSet.permissions,searchString)?key.toString():void 0}).compact().value()},controller.retrieveSelectableRealms=function(action,type,parentType,noCache){if(!$rootScope.user)return[];var realms;if(controller.isFluroAdmin())realms=FluroContent.resource("realm",!1,noCache).query({list:!0,sort:"title"});else{var permissionSets=$rootScope.user.permissionSets,searchString=action+" "+type,createableRealms=_.chain(permissionSets).filter(function(realmSet){var includedFromParent,includesType=_.includes(realmSet.permissions,searchString);if(parentType&&parentType.length){var includesParent=_.includes(realmSet.permissions,action+" "+parentType),includesVariations=_.includes(realmSet.permissions,"include defined "+parentType);includedFromParent=includesParent&&includesVariations}return includesType||includedFromParent}).compact().sortBy("title").value();realms=createableRealms}return realms},controller.can=function(action,type,parentType){if(!$rootScope.user)return!1;if(controller.isFluroAdmin())return!0;var perm=action+" "+type,realms=[];switch(action){case"view any":var canViewAnyRealms=controller.retrieveActionableRealms("view any "+type),canEditAnyRealms=controller.retrieveActionableRealms("edit any "+type);realms=realms.concat(canViewAnyRealms),realms=realms.concat(canEditAnyRealms);break;case"view own":var canViewOwnRealms=controller.retrieveActionableRealms("view own "+type),canEditOwnRealms=controller.retrieveActionableRealms("edit own "+type);realms=realms.concat(canViewOwnRealms),realms=realms.concat(canEditOwnRealms);break;default:realms=controller.retrieveActionableRealms(perm)}if(realms.length)return!0;if(parentType&&parentType.length){var includeDefined=controller.retrieveActionableRealms("include defined "+parentType);if(!includeDefined.length)return!1;switch(action){case"view any":{controller.retrieveActionableRealms("view any "+parentType),controller.retrieveActionableRealms("edit any "+parentType)}realms=realms.concat(canViewAnyRealms),realms=realms.concat(canEditAnyRealms);break;case"view own":var canViewOwnParentRealms=controller.retrieveActionableRealms("view own "+parentType),canEditOwnParentRealms=controller.retrieveActionableRealms("edit own "+parentType);realms=realms.concat(canViewOwnParentRealms),realms=realms.concat(canEditOwnParentRealms);break;default:realms=controller.retrieveActionableRealms(action+" "+parentType)}if(realms.length)return!0}return!1},controller.isAuthor=function(item){if(!$rootScope.user)return!1;var author=!1;return author=_.isObject(item.author)?item.author._id==$rootScope.user._id:item.author==$rootScope.user._id,!author&&item.owners&&item.owners.length&&(author=_.some(item.owners,function(owner){var ownerId=owner;return ownerId&&ownerId._id&&(ownerId=ownerId._id),ownerId==$rootScope.user._id})),$rootScope.user._id==item._id&&(author=!0),author},controller.canEditItem=function(item,user){if(!item)return console.log("No item"),!1;if(!$rootScope.user)return console.log("No user"),!1;var userAccountID=$rootScope.user.account;userAccountID&&(userAccountID=userAccountID._id);var contentAccountID=item.account;if(contentAccountID&&contentAccountID._id&&(contentAccountID=contentAccountID._id),contentAccountID&&contentAccountID!=userAccountID)return!1;if(controller.isFluroAdmin())return!0;var parentType,definitionName=item._type;item.definition&&(definitionName=item.definition,parentType=item._type);var author=controller.isAuthor(item);if(user&&(definitionName="user",author))return!0;switch(definitionName){case"realm":return controller.has(author?"edit own realm":"edit any realm")}var editAnyRealms=controller.retrieveActionableRealms("edit any "+definitionName),editOwnRealms=controller.retrieveActionableRealms("edit own "+definitionName),contentRealmIds=_.map(item.realms,function(realm){return realm._id?realm._id:realm});if(parentType&&parentType.length){var includeDefined=controller.retrieveActionableRealms("include defined "+parentType);if(includeDefined.length){var canEditAnyParentRealms=controller.retrieveActionableRealms("edit any "+parentType);editAnyRealms=editAnyRealms.concat(canEditAnyParentRealms);var canEditOwnParentRealms=controller.retrieveActionableRealms("edit own "+parentType);editOwnRealms=editOwnRealms.concat(canEditOwnParentRealms)}}var matchedAnyRealms=_.intersection(editAnyRealms,contentRealmIds);if(matchedAnyRealms.length)return!0;if(author){var matchedOwnRealms=_.intersection(editOwnRealms,contentRealmIds);if(matchedOwnRealms.length)return!0}console.log("No Realms",contentRealmIds,editOwnRealms,matchedOwnRealms,matchedAnyRealms)},controller.canViewItem=function(item,user){if(!$rootScope.user)return!1;if(controller.isFluroAdmin())return!0;var parentType,definitionName=item._type;item.definition&&(definitionName=item.definition,parentType=item._type);var author=controller.isAuthor(item);if(user&&(definitionName="user",author))return!0;var viewAnyRealms=controller.retrieveActionableRealms("view any "+definitionName),viewOwnRealms=controller.retrieveActionableRealms("view own "+definitionName),editAnyRealms=controller.retrieveActionableRealms("edit any "+definitionName),editOwnRealms=controller.retrieveActionableRealms("edit own "+definitionName),combinedAnyRealms=[];combinedAnyRealms=combinedAnyRealms.concat(viewAnyRealms),combinedAnyRealms=combinedAnyRealms.concat(editAnyRealms);var combinedOwnRealms=[];combinedOwnRealms=combinedOwnRealms.concat(viewOwnRealms),combinedOwnRealms=combinedOwnRealms.concat(editOwnRealms);var contentRealmIds=_.map(item.realms,function(realm){return realm._id?realm._id:realm});if(parentType&&parentType.length){var includeDefined=controller.retrieveActionableRealms("include defined "+parentType);if(includeDefined.length){var canEditAnyParentRealms=controller.retrieveActionableRealms("edit any "+parentType),canViewAnyParentRealms=controller.retrieveActionableRealms("view any "+parentType);combinedAnyRealms=combinedAnyRealms.concat(canEditAnyParentRealms,canViewAnyParentRealms);var canEditOwnParentRealms=controller.retrieveActionableRealms("edit own "+parentType),canViewOwnParentRealms=controller.retrieveActionableRealms("view own "+parentType);combinedOwnRealms=combinedOwnRealms.concat(canEditOwnParentRealms,canViewOwnParentRealms)}}var matchedAnyRealms=_.intersection(combinedAnyRealms,contentRealmIds);if(matchedAnyRealms.length)return!0;if(author){var matchedOwnRealms=_.intersection(combinedOwnRealms,contentRealmIds);if(matchedOwnRealms.length)return!0}},controller.canDeleteItem=function(item,user){if(!$rootScope.user)return!1;var userAccountID=$rootScope.user.account;userAccountID&&(userAccountID=userAccountID._id);var contentAccountID=item.account;if(contentAccountID&&contentAccountID._id&&(contentAccountID=contentAccountID._id),contentAccountID&&contentAccountID!=userAccountID)return!1;if(controller.isFluroAdmin())return!0;var parentType,definitionName=item._type;item.definition&&(definitionName=item.definition,parentType=item._type);var author=controller.isAuthor(item);if(user&&(definitionName="user",author))return!0;switch(definitionName){case"realm":return controller.has(author?"delete own realm":"delete any realm")}var deleteAnyRealms=controller.retrieveActionableRealms("delete any "+definitionName),deleteOwnRealms=controller.retrieveActionableRealms("delete own "+definitionName),contentRealmIds=_.map(item.realms,function(realm){return realm&&realm._id?realm._id:realm});if(parentType&&parentType.length){var includeDefined=controller.retrieveActionableRealms("include defined "+parentType);if(includeDefined.length){var canDeleteAnyParentRealms=controller.retrieveActionableRealms("delete any "+parentType);deleteAnyRealms=deleteAnyRealms.concat(canDeleteAnyParentRealms);var canDeleteOwnParentRealms=controller.retrieveActionableRealms("delete own "+parentType);deleteOwnRealms=deleteOwnRealms.concat(canDeleteOwnParentRealms)}}var matchedAnyRealms=_.intersection(deleteAnyRealms,contentRealmIds);if(matchedAnyRealms.length)return!0;if(author){var matchedOwnRealms=_.intersection(deleteOwnRealms,contentRealmIds);if(matchedOwnRealms.length)return!0}},controller.resolveIf=function(bool){var deferred=$q.defer();return bool?deferred.resolve():deferred.reject(),deferred.promise},controller});